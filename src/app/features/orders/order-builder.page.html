<ion-header>
  <ion-toolbar>
    <ion-title>Admin</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="onLogout()">Logout</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>

  <!-- Prenotazione (oggi) -->
  <ion-item>
    <ion-label position="stacked">Prenotazione (oggi)</ion-label>
    <ion-select
      placeholder="Seleziona (opzionale)"
      [value]="selectedReservation()"
      (ionChange)="onPickReservation($any($event.detail).value)">
      <ion-select-option *ngFor="let r of pickList()" [value]="r">
        {{ r.start_at | date:'HH:mm' }} â€” {{ r.display_name || (r.customer_first + ' ' + (r.customer_last || '')) || 'Cliente' }}
        ({{ r.party_size || '?' }} coperti)
      </ion-select-option>
    </ion-select>
  </ion-item>

  <!-- Anagrafica -->
  <ion-item>
    <ion-label position="stacked">Cliente</ion-label>
    <ion-input inputmode="text" placeholder="Nome e cognome"
               [value]="customerName()"
               (ionInput)="customerName.set($any($event.target).value || '')"></ion-input>
  </ion-item>

  <ion-item>
    <ion-label position="stacked">Telefono</ion-label>
    <ion-input inputmode="tel" placeholder="+39â€¦"
               [value]="customerPhone()"
               (ionInput)="customerPhone.set($any($event.target).value || '')"></ion-input>
  </ion-item>

  <ion-item>
    <ion-label position="stacked">Note</ion-label>
    <ion-textarea autoGrow="true" placeholder="Es. senza cipolla"
                  [value]="note()"
                  (ionInput)="note.set($any($event.target).value || '')"></ion-textarea>
  </ion-item>

  <!-- Coperti -->
  <div style="padding:16px 16px 8px;">
    <div style="display:flex; align-items:center; gap:12px;">
      <div style="font-weight:600;">Coperti</div>
      <ion-button size="small" fill="outline" (click)="decCovers()">âˆ’</ion-button>
      <div style="min-width:28px; text-align:center;">{{ covers() }}</div>
      <ion-button size="small" fill="outline" (click)="incCovers()">+</ion-button>
    </div>
    <small>â‚¬ {{ COVER_PRICE | number:'1.2-2' }} a coperto (conteggiato nel totale)</small>
  </div>

  <!-- Categorie -->
  <ion-segment [value]="selectedCategory()"
               (ionChange)="selectedCategory.set($any($event.detail).value)"
               mode="md" style="margin:8px 12px;">
    <ion-segment-button value="TUTTI">TUTTI</ion-segment-button>
    <ion-segment-button *ngFor="let c of categories()" [value]="c">{{ c }}</ion-segment-button>
  </ion-segment>

  <!-- Grid menu -->
  <ion-grid>
    <ion-row>
      <ion-col size="12" *ngFor="let m of filteredMenu(); trackBy: trackByMenuId">
        <ion-card class="menu-card">
          <ion-card-header>
            <ion-card-title style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
              <span>{{ m.name }}</span>
              <span>â‚¬ {{ m.price | number:'1.2-2' }}</span>
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="actions">
              <ion-button size="small" fill="outline" (click)="decCartByBaseName(m.name)">âˆ’</ion-button>
              <ion-badge color="tertiary">{{ qtyInCart(m.name) }}</ion-badge>
              <ion-button size="small" fill="outline" (click)="incCartByBaseName(m.name, m)">+</ion-button>

              <ion-badge *ngIf="hasCustomFor(m.name)" color="warning" style="margin-left:6px;">
                custom {{ ' (' + (customLinesCount()) + ')' }}
              </ion-badge>

              <ion-button size="small" fill="clear" (click)="openCustomize(m)">Personalizza</ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- === INIZIO BLOCCO: ðŸ“¦ RIEPILOGO CARRELLO (sticky sopra al footer) === -->
  <ion-list class="cart-summary" inset="true">
    <ion-item lines="full">
      <ion-label>
        <div class="cs-header">
          <div class="title">Carrello</div>
          <ion-badge color="primary">{{ itemsCount() }}</ion-badge>
        </div>
        <div class="totline">
          <small>
            Base: â‚¬ {{ cartBaseTotal() | number:'1.2-2' }}
            <ng-container *ngIf="hasExtrasInCart()">
              â€” Extra tot: â‚¬ {{ cartExtrasTotal() | number:'1.2-2' }}
              <ng-container *ngIf="includeExtrasInTotal()"> (inclusi)</ng-container>
            </ng-container>
          </small>
        </div>
      </ion-label>
    </ion-item>

    <ion-item *ngFor="let l of cart()" lines="full">
      <ion-label>
        <div class="line-top">
          <div>
            <strong>{{ l.name }}</strong>
            <ion-icon *ngIf="(l.notes || '').trim()" name="color-wand-outline" title="Personalizzato"></ion-icon>
          </div>
          <div>Ã— {{ l.qty }}</div>
        </div>

        <div class="line-sub">
          <small>
            Base: â‚¬ {{ l.price | number:'1.2-2' }}
            <ng-container *ngIf="(l.extra_total || 0) > 0">
              â€” Extra: â‚¬ {{ l.extra_total | number:'1.2-2' }}
              <ng-container *ngIf="includeExtrasInTotal()"> (inclusi)</ng-container>
            </ng-container>
          </small>
        </div>

        <div *ngIf="(l.notes || '').trim()" class="line-notes">
          <small>{{ l.notes }}</small>
        </div>
      </ion-label>

      <ion-buttons slot="end">
        <ion-button size="small" fill="clear" (click)="decLine(l)">âˆ’</ion-button>
        <ion-badge>{{ l.qty }}</ion-badge>
        <ion-button size="small" fill="clear" (click)="incLine(l)">+</ion-button>
        <ion-button size="small" color="danger" fill="clear" (click)="removeCartLine(l)">
          <ion-icon name="trash-outline"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-item>

    <ion-item *ngIf="cart().length === 0" lines="none">
      <ion-label><ion-note color="medium">Carrello vuoto.</ion-note></ion-label>
    </ion-item>
  </ion-list>
  <!-- spacer per non farlo â€œtoccareâ€ il footer -->
  <div class="cart-spacer"></div>
  <!-- === FINE BLOCCO: ðŸ“¦ RIEPILOGO CARRELLO === -->

  <!-- Footer sticky -->
  <div class="cart-footer">
    <div>
      <small>
        {{ itemsCount() }} articoli â€” Totale â‚¬ {{ total() | number:'1.2-2' }}
        <ng-container *ngIf="includeExtrasInTotal()"> (incl. extra)</ng-container>
      </small><br>
      <small class="covers">Coperti: {{ covers() }} Ã— â‚¬ {{ COVER_PRICE | number:'1.2-2' }} = â‚¬ {{ (covers() * COVER_PRICE) | number:'1.2-2' }}</small>
    </div>

    <div style="display:flex; gap:8px;">
      <ion-button size="small" fill="outline" (click)="clearCart()">Svuota</ion-button>
      <ion-button size="small" (click)="confirmOrder()">Conferma ordine</ion-button>
    </div>
  </div>

</ion-content>
