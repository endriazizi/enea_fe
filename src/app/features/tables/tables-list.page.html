<!-- src/app/features/tables/tables-list.page.html -->
<ion-header>
  <ion-toolbar>
    <ion-title>Admin</ion-title>
    <ion-buttons slot="end">
      <ion-button routerLink="/orders/new">Nuovo ordine</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Layout SPLIT: a sinistra tavoli, a destra preview (solo desktop) -->
  <div class="split-layout">

    <!-- ===== COLONNA SINISTRA: Tavoli ===== -->
    <div class="left-col">

      <!-- Data (UI) -->
      <div class="date-ui">
        <ion-chip color="primary" [outline]="true">
          <ion-icon name="calendar-outline"></ion-icon>
          <ion-label>{{ selectedDayForPicker() | date:'EEEE dd/MM/yyyy' }}</ion-label>
        </ion-chip>

        <!-- Quick day picker -->
        <!-- üîÅ Evento ora emette string ISO direttamente -->
        <app-date-quick
          [selected]="selectedDayForPicker()"
          (picked)="onQuickFilterDay($event)">
        </app-date-quick>
      </div>

      <!-- Filtri rapidi -->
      <div class="filters">
        <!-- Stato: stile pill + scrollabile, mode dinamico iOS/Android in 1 riga -->
        <ion-segment
          [mode]="isIOS ? 'ios' : 'md'"
          scrollable="true"
          [value]="filterState()"
          (ionChange)="onFilterChange($event)">
          <ion-segment-button value="all">Tutti</ion-segment-button>
          <ion-segment-button value="free">Liberi</ion-segment-button>
          <ion-segment-button value="upcoming">Arrivo</ion-segment-button>
          <ion-segment-button value="busy">Occupati</ion-segment-button>
          <ion-segment-button value="cleaning">Pulizia</ion-segment-button>
        </ion-segment>

        <div class="row2">
          <ion-searchbar
            placeholder="Cerca"
            [value]="filterText()"
            (ionInput)="onSearchChange($event)">
          </ion-searchbar>

          <!-- Sale: pill + scrollabile, mode dinamico iOS/Android in 1 riga -->
          <ion-segment
            [mode]="isIOS ? 'ios' : 'md'"
            scrollable="true"
            [value]="filterRoomId()"
            (ionChange)="onRoomChange($event)">
            <ion-segment-button *ngFor="let r of roomOptions()" [value]="r.id">
              {{ r.name }}
            </ion-segment-button>
          </ion-segment>
        </div>
      </div>

      <!-- KPI -->
      <div class="kpi">
        <ion-chip color="primary">üë• {{ kpiPeopleTotal() }} tot</ion-chip>
        <ion-chip color="success">üßë‚Äçüç≥ IN SALA {{ kpiPeopleCheckIn() }}</ion-chip>
        <ion-chip color="warning">üü° {{ kpiTablesUpcoming() }}</ion-chip>
        <ion-chip color="danger">üî¥ {{ kpiTablesBusy() }}</ion-chip>
        <ion-chip color="tertiary">üü¢ {{ kpiTablesFree() }} ({{ kpiFreeSeatsTotal() }} posti: {{ kpiFreeSeatsDist() }})</ion-chip>
      </div>

      <!-- Grid tavoli -->
      <ion-grid>
        <ion-row>
          <ion-col size="12" size-md="6" size-lg="4" *ngFor="let t of tablesFilteredSig(); trackBy: trackByTableId">
            <ion-card class="table-card" (click)="onOpenPreview(t)">
              <ion-card-header>
                <ion-card-title class="title">
                  <span>TAV. {{ t.number }} ‚Ä¢ {{ t.room_name }}</span>
                  <ion-badge [color]="t.state==='busy' ? 'danger' : (t.state==='upcoming' ? 'warning' : (t.state==='free' ? 'success' : 'primary'))">
                    {{ t.state | uppercase }}
                  </ion-badge>
                </ion-card-title>
              </ion-card-header>

              <ion-card-content>
                <div class="meta">
                  <div *ngIf="t.resNow; else whenFree">
                    <ion-icon name="time-outline"></ion-icon>
                    {{ t.resNow?.start_at | date:'HH:mm' }}‚Äì{{ t.resNow?.end_at | date:'HH:mm' }}
                    ‚Ä¢ <ion-icon name="people-outline"></ion-icon> {{ t.resNow?.covers || '?' }}
                    <span class="name">‚Ä¢ {{ t.resNow?.customer_name }}</span>
                  </div>
                  <ng-template #whenFree>
                    <div *ngIf="t.resNext; else noRes">
                      <ion-icon name="navigate-outline"></ion-icon>
                      Arrivo {{ t.resNext?.start_at | date:'HH:mm' }}
                      ‚Ä¢ {{ t.resNext?.customer_name }}
                    </div>
                    <ng-template #noRes>
                      <div class="free">Capienza: {{ t.capacity }}</div>
                    </ng-template>
                  </ng-template>

                  <div *ngIf="t.state==='cleaning'">
                    üîµ Pulizia: {{ formatMMSS(t.cleaningRemainingSec) }}
                  </div>
                </div>

                <!-- Bottoni (stopPropagation per non aprire preview se clicco) -->
                <div class="actions" (click)="$event.stopPropagation()">
                  <ion-button size="small" fill="outline" (click)="openDetails(t)">Dettagli</ion-button>
                  <ion-button size="small" (click)="startOrder(t)">Ordine</ion-button>
                  <ion-button size="small" fill="outline" (click)="openActions(t)">‚Ä¶</ion-button>
                </div>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>

    </div>

    <!-- ===== COLONNA DESTRA: Order Inspector (solo desktop) ===== -->
    <aside class="right-col" *ngIf="isDesktop() && previewOpen()">
      <app-order-inspector
        [table]="previewTable()"
        [orders]="previewList()"
        [active]="previewActive()"
        [busy]="previewBusy()"
        (openBuilder)="openInBuilderFromPreview()"
        (printBill)="printBillFromPreview()"
        (printComanda)="printComandaFromPreview($event)"
        (close)="onClosePreview()">
      </app-order-inspector>
    </aside>
  </div>

  <!-- ===== MODAL MOBILE: stesso contenuto del pannello ===== -->
  <ion-modal [isOpen]="!isDesktop() && previewOpen()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ previewTable() ? ('Tav. ' + previewTable()?.number + ' ‚Ä¢ ' + previewTable()?.room_name) : 'Ordine' }}</ion-title>
          <ion-buttons slot="end"><ion-button (click)="onClosePreview()">Chiudi</ion-button></ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <app-order-inspector
          [table]="previewTable()"
          [orders]="previewList()"
          [active]="previewActive()"
          [busy]="previewBusy()"
          (openBuilder)="openInBuilderFromPreview()"
          (printBill)="printBillFromPreview()"
          (printComanda)="printComandaFromPreview($event)"
          (close)="onClosePreview()">
        </app-order-inspector>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
