<!-- src/app/features/orders/order-builder.page.html -->

<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/orders"></ion-back-button>
    </ion-buttons>
    <ion-title>Nuovo ordine</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div style="max-width: 980px; margin: 0 auto; padding: 12px; display: grid; gap: 12px; grid-template-columns: 1fr;">

    <!-- ==== Anagrafica ===================================================== -->
    <ion-list inset="true">
      <ion-item lines="full">
        <ion-label position="stacked">Nome cliente</ion-label>
        <ion-input placeholder="Mario Rossi"
          (ionInput)="customerName.set(($any($event).detail?.value ?? ''))">
        </ion-input>
      </ion-item>

      <ion-item lines="full">
        <ion-label position="stacked">Telefono</ion-label>
        <ion-input type="tel" inputmode="tel" placeholder="+39 …"
          (ionInput)="customerPhone.set(($any($event).detail?.value ?? ''))">
        </ion-input>
      </ion-item>

      <ion-item lines="full">
        <ion-label position="stacked">Note</ion-label>
        <ion-textarea autoGrow="true" placeholder="Es. senza cipolla"
          (ionInput)="note.set(($any($event).detail?.value ?? ''))">
        </ion-textarea>
      </ion-item>

      <ion-note style="margin:6px 12px 8px; display:block; opacity:.7">
        Compila almeno il nome e aggiungi un prodotto al carrello.
      </ion-note>
    </ion-list>

    <!-- ==== Layout 2 colonne (desktop) =================================== -->
    <div style="display:grid; grid-template-columns: 1fr; gap:12px;"
         [style.grid-template-columns]="'1fr 1fr'">

      <!-- Catalogo -->
      <ion-list inset="true">
        <ion-item lines="none">
          <ion-label>
            <div style="font-weight:600">Catalogo</div>
            <div style="font-size:12px; opacity:.7">Tap per aggiungere</div>
          </ion-label>
          <ion-badge color="medium">{{ menu().length }}</ion-badge>
        </ion-item>

        <ion-item *ngFor="let r of menu(); trackBy: trackByMenuName" lines="full">
          <ion-label>
            {{ r.name }}
            <div style="font-size:12px; opacity:.7">€ {{ r.price | number:'1.2-2':'it-IT' }}</div>
          </ion-label>
          <ion-buttons slot="end">
            <ion-button size="small" (click)="addItem(r)">+ aggiungi</ion-button>
          </ion-buttons>
        </ion-item>
      </ion-list>

      <!-- Carrello -->
      <ion-list inset="true">
        <ion-item lines="none">
          <ion-label>
            <div style="font-weight:600">Carrello</div>
            <div style="font-size:12px; opacity:.7">Totale: € {{ total() | number:'1.2-2':'it-IT' }}</div>
          </ion-label>
          <ion-buttons slot="end">
            <ion-button fill="clear" size="small" (click)="clearCart()">Svuota</ion-button>
          </ion-buttons>
        </ion-item>

        <ion-item *ngFor="let it of cart(); trackBy: trackByCartName" lines="full">
          <ion-label>
            {{ it.name }}
            <div style="font-size:12px; opacity:.7">€ {{ it.price | number:'1.2-2':'it-IT' }}</div>
          </ion-label>
          <ion-buttons slot="end">
            <ion-button size="small" (click)="dec(it)">-</ion-button>
            <ion-badge color="primary">{{ it.qty }}</ion-badge>
            <ion-button size="small" (click)="inc(it)">+</ion-button>
            <ion-button color="danger" size="small" (click)="remove(it)">rimuovi</ion-button>
          </ion-buttons>
        </ion-item>

        <ion-item lines="none" *ngIf="!cart().length">
          <ion-label style="opacity:.7">Carrello vuoto</ion-label>
        </ion-item>
      </ion-list>

    </div>

    <!-- CTA -->
    <div style="padding: 0 4px 16px">
      <ion-button expand="block" size="large"
        [disabled]="busy() || !canSubmit()" (click)="submit()">
        {{ busy() ? 'Invio…' : 'Conferma e crea' }} — € {{ total() | number:'1.2-2':'it-IT' }}
      </ion-button>
    </div>
  </div>
</ion-content>
