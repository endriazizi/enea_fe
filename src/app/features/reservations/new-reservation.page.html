<ion-content class="ion-padding page-resv">

  <form class="compact" [formGroup]="form" (ngSubmit)="onSubmit()">

    <!-- ===== Sezione 0: Cerca contatto (Google) - IN ALTO ===== -->
    <ion-list inset="true" class="mt-6">
      <ion-item lines="full">
        <ion-label position="stacked">Cerca in Google Contacts…</ion-label>

        <app-gcontacts-autocomplete
          class="as-input"
          [results]="gcResults()"
          [searching]="gcSearching()"
          placeholder="Cerca in Google Contacts…"
          (queryChange)="onGcQueryChange($event)"
          (selected)="onContactSelected($event)">
        </app-gcontacts-autocomplete>
      </ion-item>

      <!-- Banner + CTA: appare finché non c'è consenso/token -->
      <ion-item lines="none" *ngIf="gcNeedsConsent()" style="padding-top:6px;">
        <ion-note slot="start" color="warning">Accesso necessario per leggere i contatti Google.</ion-note>
        <ion-button slot="end" size="small" fill="outline" (click)="onGcConnectClick()">
          <ion-icon name="logo-google" slot="start"></ion-icon>
          Connetti Google
        </ion-button>
      </ion-item>
    </ion-list>

    <!-- ===== Sezione 1: Dati cliente ===== -->
    <ion-list inset="true">
      <ion-item lines="full">
        <ion-label position="stacked">Cognome</ion-label>
        <ion-input
          formControlName="customer_last"
          class="u-upper-visual"
          (ionBlur)="upperOnBlur('customer_last')"
          autocomplete="family-name"
          inputmode="text"
          spellcheck="false"
          autocorrect="off">
        </ion-input>
      </ion-item>

      <ion-item lines="full">
        <ion-label position="stacked">Nome</ion-label>
        <ion-input
          formControlName="customer_first"
          class="u-upper-visual"
          (ionBlur)="upperOnBlur('customer_first')"
          autocomplete="given-name"
          inputmode="text"
          spellcheck="false"
          autocorrect="off">
        </ion-input>
      </ion-item>

      <ion-item lines="full">
        <ion-label position="stacked">Telefono</ion-label>
        <ion-input formControlName="phone" inputmode="tel" autocomplete="tel"></ion-input>
      </ion-item>

      <ion-item lines="full">
        <ion-label position="stacked">Email</ion-label>
        <ion-input formControlName="email" type="email" autocomplete="email" inputmode="email"></ion-input>
      </ion-item>

      <ion-item lines="none" class="pt-2 pb-0">
        <ion-note color="danger" *ngIf="emailCtrl.invalid && (emailCtrl.dirty || emailCtrl.touched)">
          Inserisci un’email valida (opzionale).
        </ion-note>
      </ion-item>
    </ion-list>

    <!-- ===== Sezione 2: Coperti ===== -->
    <ion-list inset="true">
      <ion-item lines="full">
        <ion-label>Coperti</ion-label>
        <div slot="end" style="display:flex; align-items:center; gap:8px;">
          <ion-button fill="outline" size="default" (click)="decParty()" aria-label="Diminuisci coperti">
            <ion-icon name="remove-circle"></ion-icon>
          </ion-button>
          <span style="min-width: 2ch; text-align:center;">{{ form.value.party_size || 1 }}</span>
          <ion-button fill="outline" size="default" (click)="incParty()" aria-label="Aumenta coperti">
            <ion-icon name="add-circle"></ion-icon>
          </ion-button>
        </div>
      </ion-item>
    </ion-list>

    <!-- ===== Sezione 3: Data & Orario ===== -->
    <ion-list inset="true">
      <ion-item lines="full">
        <ion-label position="stacked">
          Data
          <div class="label-sub">Oggi: {{ todayLabel() }}</div>
        </ion-label>

        <app-date-quick
          [title]="'Giorno rapido'"
          [showTodayLine]="false"
          [days]="7"
          [selected]="selectedDayForPicker()"
          (selectedChange)="onQuickFilterDay($event)">
        </app-date-quick>
      </ion-item>

      <!-- PRANZO -->
      <div *ngIf="lunchSlots.length" class="px-12 py-8">
        <div class="sec-title">Pranzo</div>
        <div class="btn-grid">
          <ion-button
            *ngFor="let t of lunchSlots"
            [fill]="selectedTime() === t ? 'solid' : 'outline'"
            [disabled]="isSlotDisabled(selectedDateISO(), t)"
            (click)="onSelectTime(t)">
            {{ t }}
          </ion-button>
        </div>
      </div>

      <!-- CENA -->
      <div *ngIf="dinnerSlots.length" class="px-12 pb-12">
        <div class="sec-title">Cena</div>
        <div class="btn-grid">
          <ion-button
            *ngFor="let t of dinnerSlots"
            [fill]="selectedTime() === t ? 'solid' : 'outline'"
            [disabled]="isSlotDisabled(selectedDateISO(), t)"
            (click)="onSelectTime(t)">
            {{ t }}
          </ion-button>
        </div>
      </div>

      <ion-item lines="none" class="pt-2 pb-0">
        <ion-note *ngIf="form.value.start_at" color="primary" style="display:block; width:100%;">
          Selezionato: {{ selectedDateHuman() }}, {{ selectedTime() }}
        </ion-note>
      </ion-item>

      <!-- Toggle calendario avanzato -->
      <div class="px-12 pt-6">
        <ion-button fill="clear" size="small" (click)="toggleAdvanced()">
          {{ showAdvanced() ? 'Chiudi calendario' : 'Scegli da calendario' }}
        </ion-button>
        <div *ngIf="showAdvanced()">
          <ion-datetime
            presentation="date-time"
            [value]="advancedValue()"
            (ionChange)="onAdvancedPick($event)">
          </ion-datetime>
        </div>
      </div>

      <ion-item lines="none" class="pt-2 pb-0">
        <ion-note color="danger" *ngIf="startCtrl.invalid && (startCtrl.dirty || startCtrl.touched)">
          Scegli data e ora (obbligatorio).
        </ion-note>
      </ion-item>
    </ion-list>

    <!-- ===== Sezione 4: Sala/Tavolo ===== -->
    <ion-list inset="true">
      <ion-item lines="full">
        <ion-label position="stacked">Sala</ion-label>
        <ion-select
          formControlName="room_id"
          interface="popover"
          placeholder="Seleziona sala"
          (ionChange)="onRoomChange()">
          <ion-select-option *ngFor="let r of rooms()" [value]="r.id">
            {{ r.name }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item lines="full">
        <ion-label position="stacked">Tavolo</ion-label>
        <ion-select
          formControlName="table_id"
          interface="popover"
          placeholder="Seleziona tavolo">
          <ion-select-option *ngFor="let t of tables()" [value]="t.id">
            Tavolo {{ t.table_number || t.label || t.id }} ({{ t.capacity || '?' }})
          </ion-select-option>
        </ion-select>
      </ion-item>
    </ion-list>

    <!-- ===== Sezione 5: Note ===== -->
    <ion-list inset="true">
      <ion-item lines="full">
        <ion-label position="stacked">Note</ion-label>
        <ion-textarea
          formControlName="notes"
          autoGrow="true"
          enterkeyhint="done"
          placeholder="Es. intolleranze, preferenza tavolo, segnalazioni…">
        </ion-textarea>
      </ion-item>
    </ion-list>

    <!-- CTA -->
    <div class="px-8 py-12">
      <ion-button expand="block" size="large" type="submit" [disabled]="loading() || form.invalid">
        {{ loading() ? 'Creazione…' : 'Crea prenotazione' }}
      </ion-button>
    </div>
  </form>

  <!-- === FAB (mobile) ====================================================== -->
  <ion-fab slot="fixed" horizontal="end" vertical="bottom" class="ion-hide-md-up fab-resv">
    <ion-fab-button title="Azioni">
      <ion-icon name="ellipsis-vertical"></ion-icon>
    </ion-fab-button>
    <ion-fab-list side="top">
      <ion-fab-button routerLink="/reservations" title="Vai alla lista">
        <ion-icon name="list"></ion-icon>
      </ion-fab-button>
      <ion-fab-button (click)="clearForm()" title="Pulisci form">
        <ion-icon name="remove-circle"></ion-icon>
      </ion-fab-button>
    </ion-fab-list>
  </ion-fab>

</ion-content>
