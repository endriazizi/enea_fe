<!-- src/app/features/orders/order-builder.page.html -->
<ion-header>
  <ion-toolbar>
    <ion-title>Nuovo Ordine</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="pickModalOpen.set(true)">Da prenotazione</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>

  <!-- Cliente + Note -->
  <ion-list inset="true" style="margin-top:10px;">
    <ion-item>
      <ion-label position="stacked">Cliente</ion-label>
      <ion-input autocomplete="name" [value]="customerName()" (ionInput)="onNameInput($any($event))"></ion-input>
    </ion-item>

    <ion-item>
      <ion-label position="stacked">Telefono</ion-label>
      <ion-input autocomplete="tel" [value]="customerPhone()" (ionInput)="onPhoneInput($any($event))"></ion-input>
    </ion-item>

    <ion-item>
      <ion-label position="stacked">Note</ion-label>
      <ion-textarea autoGrow="true" placeholder="Es. senza cipolla" [value]="note()" (ionInput)="onNoteInput($any($event))"></ion-textarea>
    </ion-item>
  </ion-list>

  <!-- Coperti -->
  <ion-item lines="none" style="margin-top:12px;">
    <ion-label>
      <b>Coperti</b><br/>
      <small>€ {{ COVER_PRICE }} a coperto (conteggiato nel totale)</small>
    </ion-label>
    <ion-buttons slot="end" style="gap:8px; align-items:center;">
      <ion-button fill="outline" size="small" (click)="decCovers()">−</ion-button>
      <ion-note>{{ covers() || 0 }}</ion-note>
      <ion-button size="small" (click)="incCovers()">+</ion-button>
    </ion-buttons>
  </ion-item>

  <!-- Categorie -->
  <div style="padding:12px 16px 4px;">
    <ion-segment [value]="selectedCategory()" (ionChange)="selectedCategory.set($any($event.detail).value || 'TUTTI')">
      <ion-segment-button value="TUTTI">Tutti</ion-segment-button>
      <ion-segment-button *ngFor="let c of categories()" [value]="c">{{ c }}</ion-segment-button>
    </ion-segment>
  </div>

  <!-- Catalogo -->
  <ion-grid>
    <ion-row>
      <ion-col size="12" size-sm="6" size-lg="4" *ngFor="let m of filteredMenu(); trackBy: trackByMenuName">
        <ion-card class="menu-card">
          <ion-card-header>
            <ion-card-title>{{ m.name }}</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="price">€ {{ m.price | number:'1.2-2' }}</div>
            <div class="actions">
              <ion-button fill="outline" (click)="decCartByBaseName(m.name)">−</ion-button>
              <ion-badge color="tertiary">{{ qtyBaseInCart(m.name) }}</ion-badge>
              <ion-button (click)="addToCart(m)">+</ion-button>
              <ion-button fill="clear" *ngIf="canCustomize(m)" (click)="openCustomize(m)">Personalizza</ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- Carrello sticky -->
  <ion-footer *ngIf="cart().length > 0" class="cart-footer">
    <div class="cart-left">
      <b>{{ itemsCount() }} articoli</b> — Prodotti <b>€ {{ totalProducts() | number:'1.2-2' }}</b>
      <div class="covers">Coperti: {{ covers() }} × € {{ COVER_PRICE | number:'1.2-2' }} = <b>€ {{ coversTotal() | number:'1.2-2' }}</b></div>
      <div class="grand">Totale: <b>€ {{ total() | number:'1.2-2' }}</b></div>
    </div>
    <div class="cart-right">
      <ion-button color="medium" fill="outline" (click)="clearCart()">Svuota</ion-button>
      <ion-button [disabled]="busy()" (click)="submit()">Conferma ordine</ion-button>
    </div>
  </ion-footer>

  <!-- Modal Coperti -->
  <ion-modal [isOpen]="coversModalOpen()">
    <ng-template>
      <ion-header><ion-toolbar><ion-title>Quanti coperti?</ion-title></ion-toolbar></ion-header>
      <ion-content class="ion-padding">
        <div style="display:flex; gap:10px; align-items:center; justify-content:center; margin:24px 0;">
          <ion-button size="large" fill="outline" (click)="decCovers()">−</ion-button>
          <div style="font-size:22px; min-width:80px; text-align:center;"><b>{{ covers() || 0 }}</b></div>
          <ion-button size="large" (click)="incCovers()">+</ion-button>
        </div>
        <div style="text-align:center"><ion-button size="large" (click)="confirmCovers()">Continua</ion-button></div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal personalizzazione -->
  <ion-modal [isOpen]="customOpen()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Personalizza — {{ targetItem()?.name }}</ion-title>
          <ion-buttons slot="end"><ion-button (click)="customOpen.set(false)">Chiudi</ion-button></ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <ion-list *ngIf="ingList()?.length">
          <ion-item lines="full"><ion-label><b>Ingredienti</b></ion-label></ion-item>
          <ion-item *ngFor="let ing of ingList()">
            <ion-checkbox
              [checked]="!removedList().includes(ing)"
              (ionChange)="onToggleIngredient(ing, $any($event.detail).checked)"></ion-checkbox>
            <ion-label class="ion-padding-start">{{ ing }}</ion-label>
          </ion-item>
        </ion-list>

        <ion-list *ngIf="extrasList()?.length">
          <ion-item lines="full"><ion-label><b>Extra</b></ion-label></ion-item>
          <ion-item *ngFor="let ex of extrasList(); let i = index">
            <ion-checkbox
              [checked]="ex.selected"
              (ionChange)="onToggleExtra(i, $any($event.detail).checked)"></ion-checkbox>
            <ion-label class="ion-padding-start">{{ ex.name }} — +€ {{ ex.price | number:'1.2-2' }}</ion-label>
          </ion-item>
        </ion-list>

        <ion-item lines="full" class="ion-margin-top">
          <ion-label position="stacked">Nota riga</ion-label>
          <ion-textarea autoGrow="true" placeholder="Es. metà piccante" [value]="itemNote()" (ionInput)="itemNote.set($any($event.target).value)"></ion-textarea>
        </ion-item>

        <div style="text-align:center" class="ion-padding">
          <ion-button size="large" (click)="confirmCustomization()">Aggiungi</ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal prenotazioni -->
  <ion-modal [isOpen]="pickModalOpen()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Importa da prenotazione</ion-title>
          <ion-buttons slot="end"><ion-button (click)="pickModalOpen.set(false)">Chiudi</ion-button></ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <ion-item>
          <ion-label position="stacked">Giorno</ion-label>
          <ion-datetime presentation="date" [value]="pickDate()" (ionChange)="pickDate.set($any($event.detail).value)"></ion-datetime>
        </ion-item>
        <div class="ion-padding">
          <ion-button (click)="loadReservations()">Carica prenotazioni</ion-button>
        </div>

        <ion-list *ngIf="pickList()?.length">
          <ion-item *ngFor="let r of pickList()">
            <ion-label>
              <b>{{ r.display_name || $any(r).customer_name || (($any(r).customer_first || '') + ' ' + ($any(r).customer_last || '')) }}</b><br>
              <small>{{ $any(r).phone || $any(r).customer_phone || '' }}</small><br>
              <small>Coperti: {{ r.party_size || $any(r).people || $any(r).persons || $any(r).covers }}</small>
            </ion-label>
            <ion-buttons slot="end"><ion-button (click)="applyReservation(r)">Usa</ion-button></ion-buttons>
          </ion-item>
        </ion-list>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>
