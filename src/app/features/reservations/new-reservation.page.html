<!-- src/app/features/reservations/new-reservation.page.html -->
<ion-header>
  <ion-toolbar>
    <ion-title>Nuova prenotazione</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- Form principale -->
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <!-- 1) Cliente -->
    <ion-list inset="true">
      <ion-item>
        <ion-label position="stacked">Cognome</ion-label>
        <ion-input
          formControlName="customer_last"
          autocomplete="family-name"
          (ionInput)="forceUpper('customer_last', $event)"></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Nome</ion-label>
        <ion-input
          formControlName="customer_first"
          autocomplete="given-name"
          (ionInput)="forceUpper('customer_first', $event)"></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Telefono</ion-label>
        <ion-input formControlName="phone" autocomplete="tel"></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Email</ion-label>
        <ion-input formControlName="email" autocomplete="email" type="email"></ion-input>
      </ion-item>
      <ion-note
        *ngIf="emailCtrl.invalid && (emailCtrl.dirty || emailCtrl.touched)"
        color="danger"
        style="margin: 4px 16px 0;">Email non valida</ion-note>

      <!-- Autocomplete Google Contacts (se presente) -->
      <app-gcontacts-autocomplete
        (selected)="onContactSelected($event)"></app-gcontacts-autocomplete>
    </ion-list>

    <!-- 2) Coperti -->
    <ion-list inset="true">
      <ion-item>
        <ion-label>Coperti</ion-label>
        <ion-buttons slot="end">
          <ion-button size="large" fill="outline" (click)="decParty()" aria-label="Diminuisci coperti">−</ion-button>
          <ion-button size="large" fill="clear" disabled>{{ form.value.party_size || 1 }}</ion-button>
          <ion-button size="large" (click)="incParty()" aria-label="Aumenta coperti">+</ion-button>
        </ion-buttons>
      </ion-item>
    </ion-list>

    <!-- 3) Data & Ora (quick + avanzato) -->
    <ion-list inset="true">
      <!-- Data veloce: component “quick date” (se presente nel progetto) -->
      <app-date-quick
        [selected]="selectedDateISO()"
        (selectedChange)="onQuickDate($event)">
      </app-date-quick>

      <!-- Slot pranzo -->
      <div *ngIf="lunchSlots.length" style="padding: 0 12px 8px">
        <div style="font-size:12px; opacity:.7; margin: 4px 0 6px;">Pranzo</div>
        <ion-button
          *ngFor="let t of lunchSlots"
          size="small"
          [fill]="selectedTime() === t ? 'solid' : 'outline'"
          [disabled]="isSlotDisabled(selectedDateISO(), t)"
          (click)="onSelectTime(t)"
          style="margin: 0 6px 6px 0;">
          {{ t }}
        </ion-button>
      </div>

      <!-- Slot cena -->
      <div *ngIf="dinnerSlots.length" style="padding: 0 12px 12px">
        <div style="font-size:12px; opacity:.7; margin: 4px 0 6px;">Cena</div>
        <ion-button
          *ngFor="let t of dinnerSlots"
          size="small"
          [fill]="selectedTime() === t ? 'solid' : 'outline'"
          [disabled]="isSlotDisabled(selectedDateISO(), t)"
          (click)="onSelectTime(t)"
          style="margin: 0 6px 6px 0;">
          {{ t }}
        </ion-button>
      </div>

      <!-- Info selezione -->
      <ion-item lines="none">
        <ion-label>
          <ion-note color="primary" style="display:block">
            Selezionato: {{ selectedDateHuman() }}, {{ selectedTime() || '—' }}
          </ion-note>
        </ion-label>
        <ion-buttons slot="end">
          <ion-button fill="clear" size="small" (click)="toggleAdvanced()">
            {{ showAdvanced() ? 'Chiudi calendario' : 'Scegli da calendario' }}
          </ion-button>
        </ion-buttons>
      </ion-item>

      <!-- Calendario avanzato -->
      <div *ngIf="showAdvanced()" style="padding: 8px 12px 12px;">
        <ion-datetime
          presentation="date-time"
          [value]="advancedValue()"
          (ionChange)="onAdvancedPick($event)">
        </ion-datetime>
        <ion-note
          *ngIf="startCtrl.invalid && (startCtrl.dirty || startCtrl.touched)"
          color="danger"
          style="display:block; margin-top:6px">
          Seleziona data e ora
        </ion-note>
      </div>
    </ion-list>

    <!-- 4) Note e altri campi -->
    <ion-list inset="true">
      <ion-item>
        <ion-label position="stacked">Motivo (opzionale)</ion-label>
        <ion-input formControlName="reason"></ion-input>
      </ion-item>
      <ion-item>
        <ion-label position="stacked">Note</ion-label>
        <ion-textarea formControlName="notes" autoGrow="true"></ion-textarea>
      </ion-item>
    </ion-list>

    <!-- CTA -->
    <div style="display:flex; gap:8px; margin-top:12px;">
      <ion-button type="submit" [disabled]="loading()">
        <ion-icon name="checkmark" slot="start"></ion-icon>
        Conferma
      </ion-button>
      <ion-button fill="outline" color="medium" (click)="clearForm()">
        <ion-icon name="trash-outline" slot="start"></ion-icon>
        Pulisci
      </ion-button>
    </div>
  </form>

  <!-- FAB opzionali (mantieni se li usi altrove) -->
  <ion-fab slot="fixed" horizontal="end" vertical="bottom" class="ion-hide-md-up">
    <ion-fab-button title="Azioni">
      <ion-icon name="ellipsis-vertical"></ion-icon>
    </ion-fab-button>
    <ion-fab-list side="top">
      <!-- Azioni veloci eventuali -->
    </ion-fab-list>
  </ion-fab>
</ion-content>
